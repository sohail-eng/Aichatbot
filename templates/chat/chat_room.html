<!-- templates/chat/chat_room.html -->
{% extends 'chat/base.html' %}

{% block title %}AI Chat Room{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">AI Data Assistant</h1>
                    <div class="flex items-center space-x-4 mt-1">
                        <span class="text-sm text-gray-500">Session: {{ session_id }}</span>
                        <span id="connectionStatus" class="text-sm text-gray-500">Status: Connecting...</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="toggleSidebar" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-user mr-1"></i>
                        {% if user.is_authenticated %}
                            {{ user.get_full_name|default:user.username }}
                        {% else %}
                            Guest User
                        {% endif %}
                    </div>
                    {% if user.is_authenticated %}
                        <a href="{% url 'logout' %}" class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    {% else %}
                        <a href="{% url 'login' %}" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Chat Messages Area (Scrollable) -->
        <div class="flex-1 overflow-hidden">
            <div id="chatMessages" class="h-full overflow-y-auto p-6 space-y-4">
                <!-- Messages will be inserted here -->
            </div>
        </div>
        
        <!-- Message Input Area -->
        <div class="bg-white border-t p-4">
            <!-- File Attachment Badges -->
            <div id="fileAttachmentArea" class="mb-3 hidden">
                <div class="flex flex-wrap gap-2" id="attachedFiles">
                    <!-- Attached file badges will be displayed here -->
                </div>
            </div>
            
            <div class="flex space-x-2">
                <div class="flex-1 flex space-x-2">
                    <button id="attachFileBtn" class="bg-gray-100 text-gray-600 px-3 py-3 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" id="messageInput" placeholder="Type your message or ask about your data..." 
                           class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="sendBtn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Send
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Backdrop -->
    <div id="sidebarBackdrop" class="sidebar-backdrop hidden"></div>
    
    <!-- Right Sidebar Panel -->
    <div id="sidebar" class="w-80 bg-white shadow-lg border-l hidden">
        <div class="p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Tools & Files</h2>
                <button id="closeSidebar" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Accordion Sections -->
            <div class="space-y-2">
                <!-- File Upload Section -->
                <div class="border rounded-lg">
                    <button class="accordion-header w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg" data-section="upload">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-upload text-blue-500"></i>
                                <span class="font-medium">Upload Files</span>
                            </div>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </div>
                    </button>
                    <div class="accordion-content hidden px-4 py-3 border-t">
                        <div id="fileDropZone" class="file-drop-zone p-4 text-center rounded-lg cursor-pointer border-2 border-dashed border-gray-300 hover:border-blue-400 transition-colors">
                            <input type="file" id="fileInput" class="hidden" accept=".csv,.xlsx,.xls,.txt,.json,.pdf" multiple>
                            <p class="text-gray-600">Click or drag files here</p>
                            <p class="text-xs text-gray-500">CSV, Excel, Text, JSON, PDF</p>
                        </div>
                    </div>
                </div>
                
                <!-- Uploaded Files Section -->
                <div class="border rounded-lg">
                    <button class="accordion-header w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg" data-section="files">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-folder text-green-500"></i>
                                <span class="font-medium">Uploaded Files</span>
                                <span id="fileCount" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </div>
                    </button>
                    <div class="accordion-content hidden px-4 py-3 border-t">
                        <div id="uploadedFiles" class="space-y-2 max-h-64 overflow-y-auto sidebar-scroll">
                            <p class="text-gray-500 text-sm">No files uploaded yet</p>
                        </div>
                    </div>
                </div>
                
                <!-- Folder Path Section -->
                <div class="border rounded-lg">
                    <button class="accordion-header w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg" data-section="folder">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-folder-open text-purple-500"></i>
                                <span class="font-medium">Process Folder</span>
                            </div>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </div>
                    </button>
                    <div class="accordion-content hidden px-4 py-3 border-t">
                        <input type="text" id="folderPath" placeholder="Enter folder path" 
                               class="w-full p-2 border rounded-lg mb-2">
                        <button id="processFolderBtn" class="w-full bg-purple-500 text-white p-2 rounded-lg hover:bg-purple-600">
                            Process Folder
                        </button>
                    </div>
                </div>
                
                <!-- Database Connection Section -->
                <div class="border rounded-lg">
                    <button class="accordion-header w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg" data-section="database">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-database text-orange-500"></i>
                                <span class="font-medium">Database</span>
                                <span id="dbStatus" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">Not connected</span>
                            </div>
                            <i class="fas fa-chevron-down transform transition-transform"></i>
                        </div>
                    </button>
                    <div class="accordion-content hidden px-4 py-3 border-t">
                        <button id="dbConnectBtn" class="w-full bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600 mb-2">
                            Connect to Database
                        </button>
                        <div id="dbStatusText" class="text-xs text-gray-500">Click to connect to a database</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for attachments -->
<input type="file" id="attachmentFileInput" class="hidden" accept=".csv,.xlsx,.xls,.txt,.json,.pdf" multiple>

<!-- Database Connection Modal -->
<div id="dbModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-96 max-w-full">
        <h3 class="text-lg font-semibold mb-4">Connect to Database</h3>
        <div class="space-y-3">
            <select id="dbType" class="w-full p-2 border rounded-lg">
                <option value="mssql">Microsoft SQL Server</option>
                <option value="postgresql">PostgreSQL</option>
                <option value="mysql">MySQL</option>
            </select>
            <input type="text" id="dbServer" placeholder="Server address" class="w-full p-2 border rounded-lg">
            <input type="text" id="dbDatabase" placeholder="Database name" class="w-full p-2 border rounded-lg">
            <input type="text" id="dbUsername" placeholder="Username" class="w-full p-2 border rounded-lg">
            <input type="password" id="dbPassword" placeholder="Password" class="w-full p-2 border rounded-lg">
            <input type="number" id="dbPort" placeholder="Port (optional)" class="w-full p-2 border rounded-lg">
        </div>
        <div class="flex space-x-2 mt-4">
            <button id="dbConnectConfirm" class="flex-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600">
                Connect
            </button>
            <button id="dbConnectCancel" class="flex-1 bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    // WebSocket connection
    const sessionId = '{{ session_id }}';
    const websocketUrl = `ws://${window.location.host}/ws/chat/${sessionId}/`;
    let chatSocket = null;
    let isConnected = false;
    
    // File attachment state
    let attachedFiles = [];
    let uploadedFilesList = [];
    let sidebarVisible = true;
    let activeAccordionSection = null;
    
    // Initialize WebSocket
    function initWebSocket() {
        chatSocket = new WebSocket(websocketUrl);
        
        chatSocket.onopen = function(e) {
            isConnected = true;
            document.getElementById('connectionStatus').textContent = 'Status: Connected';
            document.getElementById('connectionStatus').className = 'text-sm text-green-600';
        };
        
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleIncomingMessage(data);
        };
        
        chatSocket.onclose = function(e) {
            isConnected = false;
            document.getElementById('connectionStatus').textContent = 'Status: Disconnected';
            document.getElementById('connectionStatus').className = 'text-sm text-red-600';
            
            // Attempt to reconnect after 3 seconds
            setTimeout(initWebSocket, 3000);
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
            showToast('Connection error. Retrying...', 'error');
        };
    }
    
    // Track processed message IDs to prevent duplicates
    const processedMessageIds = new Set();
    
    // Handle incoming messages
    function handleIncomingMessage(data) {
        const messagesContainer = document.getElementById('chatMessages');
        
        if (data.type === 'error') {
            showToast(data.message, 'error');
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            return;
        }
        
        // Handle pong messages (keep-alive responses) - don't display them
        if (data.type === 'pong') {
            console.log('Received pong at:', data.timestamp);
            return;
        }
        
        // Check for duplicate messages
        if (data.id && processedMessageIds.has(data.id)) {
            console.log('Duplicate message detected, skipping:', data.id);
            return;
        }
        
        // Add message ID to processed set
        if (data.id) {
            processedMessageIds.add(data.id);
        }

        const messageDiv = createMessageElement(data);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Remove typing indicator if present
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator && data.type !== 'typing') {
            typingIndicator.remove();
        }
    }
    
    // Create message element
    function createMessageElement(data) {
        const messageDiv = document.createElement('div');
        const isUser = data.type === 'user';
        const isSystem = data.type === 'system';
        const isTyping = data.type === 'typing';
        
        if (isTyping) {
            messageDiv.className = 'typing-indicator text-gray-500 italic text-sm';
            messageDiv.textContent = data.message;
            return messageDiv;
        }
        
        messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = `message-bubble p-3 rounded-lg shadow-md ${
            isUser ? 'bg-blue-500 text-white' : 
            isSystem ? 'bg-gray-200 text-gray-700 text-sm' : 
            'bg-white text-gray-800'
        }`;
        
        // Format message content
        const content = formatMessageContent(data.message, data.type);
        bubbleDiv.innerHTML = content;
        
        // Add timestamp
        if (data.timestamp) {
            const timeDiv = document.createElement('div');
            timeDiv.className = `text-xs mt-1 ${isUser ? 'text-blue-200' : 'text-gray-500'}`;
            timeDiv.textContent = formatTimestamp(data.timestamp);
            bubbleDiv.appendChild(timeDiv);
        }
        
        messageDiv.appendChild(bubbleDiv);
        return messageDiv;
    }
    
    // Format message content
    function formatMessageContent(message, type) {
        // Basic markdown-like formatting
        if (typeof message !== 'string') {
            message = String(message); // Ensure message is a string
        }
        message = message.replace(/```sql\n([\s\S]*?)\n```/g, '<pre class="bg-gray-800 text-green-400 p-2 rounded mt-2 text-sm overflow-x-auto"><code>$1</code></pre>');
        message = message.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded mt-2 text-sm overflow-x-auto"><code>$1</code></pre>');
        message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        message = message.replace(/\*(.*?)\*/g, '<em>$1</em>');
        message = message.replace(/\n/g, '<br>');
        
        return message;
    }
    
    // Send message
    async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message || !isConnected) return;
        
        // Prepare message with attachments
        const messageData = {
            type: 'message',
            message: message
        };
        
        // Add attached files if any (these are already uploaded files)
        if (attachedFiles.length > 0) {
            messageData.attached_files = attachedFiles.map(file => ({
                id: file.id,
                name: file.name,
                type: file.type
            }));
        }
        
        chatSocket.send(JSON.stringify(messageData));
        
        messageInput.value = '';
        
        // Clear attachments after sending
        clearAttachments();
    }
    
    // File upload handling
    function setupFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('fileDropZone');
        
        if (!dropZone || !fileInput) {
            console.error('File upload elements not found');
            return;
        }
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            console.log('Files dropped:', files);
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            console.log('File input changed:', e.target.files);
            if (e.target.files.length > 0) {
                uploadFile(e.target.files[0]);
            }
        });
    }
    
    // Sidebar and accordion handling
    function setupSidebar() {
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('sidebar');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');
        
        // Toggle sidebar
        toggleSidebarBtn.addEventListener('click', () => {
            sidebarVisible = !sidebarVisible;
            if (sidebarVisible) {
                sidebar.classList.add('show');
                sidebar.classList.remove('hidden');
                // Only show backdrop on mobile
                if (window.innerWidth <= 768) {
                    sidebarBackdrop.classList.add('show');
                    sidebarBackdrop.classList.remove('hidden');
                }
                toggleSidebarBtn.classList.add('bg-blue-500', 'text-white');
                toggleSidebarBtn.classList.remove('bg-gray-100', 'text-gray-600');
            } else {
                sidebar.classList.remove('show');
                sidebar.classList.add('hidden');
                sidebarBackdrop.classList.remove('show');
                sidebarBackdrop.classList.add('hidden');
                toggleSidebarBtn.classList.remove('bg-blue-500', 'text-white');
                toggleSidebarBtn.classList.add('bg-gray-100', 'text-gray-600');
            }
        });
        
        // Close sidebar
        closeSidebarBtn.addEventListener('click', () => {
            sidebarVisible = false;
            sidebar.classList.remove('show');
            sidebar.classList.add('hidden');
            sidebarBackdrop.classList.remove('show');
            sidebarBackdrop.classList.add('hidden');
            toggleSidebarBtn.classList.remove('bg-blue-500', 'text-white');
            toggleSidebarBtn.classList.add('bg-gray-100', 'text-gray-600');
        });
        
        // Setup accordion functionality
        setupAccordion();
        
        // Ensure backdrop is hidden on desktop by default
        if (window.innerWidth > 768) {
            sidebarBackdrop.classList.add('hidden');
        }
        
        // Close sidebar when clicking outside (only on mobile)
        document.addEventListener('click', (e) => {
            if (sidebarVisible && 
                !sidebar.contains(e.target) && 
                !toggleSidebarBtn.contains(e.target) &&
                window.innerWidth <= 768) { // Only on mobile
                sidebarVisible = false;
                sidebar.classList.remove('show');
                sidebar.classList.add('hidden');
                sidebarBackdrop.classList.remove('show');
                sidebarBackdrop.classList.add('hidden');
                toggleSidebarBtn.classList.remove('bg-blue-500', 'text-white');
                toggleSidebarBtn.classList.add('bg-gray-100', 'text-gray-600');
            }
        });
        
        // Close sidebar with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sidebarVisible) {
                sidebarVisible = false;
                sidebar.classList.remove('show');
                sidebar.classList.add('hidden');
                sidebarBackdrop.classList.remove('show');
                sidebarBackdrop.classList.add('hidden');
                toggleSidebarBtn.classList.remove('bg-blue-500', 'text-white');
                toggleSidebarBtn.classList.add('bg-gray-100', 'text-gray-600');
            }
        });
        
        // Close sidebar when clicking on backdrop (mobile only)
        sidebarBackdrop.addEventListener('click', () => {
            if (window.innerWidth <= 768) { // Only on mobile
                sidebarVisible = false;
                sidebar.classList.remove('show');
                sidebar.classList.add('hidden');
                sidebarBackdrop.classList.remove('show');
                sidebarBackdrop.classList.add('hidden');
                toggleSidebarBtn.classList.remove('bg-blue-500', 'text-white');
                toggleSidebarBtn.classList.add('bg-gray-100', 'text-gray-600');
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768 && sidebarVisible) {
                // On desktop, hide backdrop but keep sidebar open
                sidebarBackdrop.classList.remove('show');
                sidebarBackdrop.classList.add('hidden');
            } else if (window.innerWidth <= 768 && sidebarVisible) {
                // On mobile, show backdrop
                sidebarBackdrop.classList.add('show');
                sidebarBackdrop.classList.remove('hidden');
            }
        });
    }
    
    // Accordion functionality
    function setupAccordion() {
        const accordionHeaders = document.querySelectorAll('.accordion-header');
        
        accordionHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const section = header.getAttribute('data-section');
                const content = header.nextElementSibling;
                const icon = header.querySelector('.fas.fa-chevron-down, .fas.fa-chevron-up');
                
                // Close other sections
                if (activeAccordionSection && activeAccordionSection !== section) {
                    const activeHeader = document.querySelector(`[data-section="${activeAccordionSection}"]`);
                    const activeContent = activeHeader.nextElementSibling;
                    const activeIcon = activeHeader.querySelector('.fas.fa-chevron-down, .fas.fa-chevron-up');
                    
                    activeContent.classList.add('hidden');
                    activeIcon.className = 'fas fa-chevron-down transform transition-transform';
                }
                
                // Toggle current section
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    icon.className = 'fas fa-chevron-up transform transition-transform';
                    activeAccordionSection = section;
                } else {
                    content.classList.add('hidden');
                    icon.className = 'fas fa-chevron-down transform transition-transform';
                    activeAccordionSection = null;
                }
            });
        });
    }
    
    // File attachment handling (modified for uploaded files)
    function setupFileAttachments() {
        const attachFileBtn = document.getElementById('attachFileBtn');
        
        if (!attachFileBtn) {
            console.error('File attachment elements not found');
            return;
        }
        
        // Attach file button click - now opens file selection modal
        attachFileBtn.addEventListener('click', () => {
            showFileSelectionModal();
        });
    }
    
    // Show file selection modal
    function showFileSelectionModal() {
        if (uploadedFilesList.length === 0) {
            showToast('No files uploaded yet. Please upload files first.', 'error');
            return;
        }
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg w-96 max-w-full max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Select Files to Attach</h3>
                    <button class="text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-2">
                    ${uploadedFilesList.map(file => `
                        <div class="flex items-center space-x-3 p-2 border rounded-lg hover:bg-gray-50">
                            <input type="checkbox" id="select_${file.id}" value="${file.id}" 
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   ${attachedFiles.some(af => af.id === file.id) ? 'checked' : ''}>
                            <label for="select_${file.id}" class="flex items-center space-x-2 flex-1 cursor-pointer">
                                <div class="text-blue-500">
                                    <i class="fas fa-file-${getFileIcon(file.type)}"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">${file.name}</p>
                                    <p class="text-xs text-gray-500">${file.type.toUpperCase()} ‚Ä¢ ${formatFileSize(file.size)}</p>
                                </div>
                            </label>
                        </div>
                    `).join('')}
                </div>
                <div class="flex space-x-2 mt-4">
                    <button onclick="applyFileSelection()" class="flex-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">
                        Attach Selected
                    </button>
                    <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add event listeners to checkboxes
        uploadedFilesList.forEach(file => {
            const checkbox = document.getElementById(`select_${file.id}`);
            checkbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (!attachedFiles.some(af => af.id === file.id)) {
                        attachedFiles.push({
                            id: file.id,
                            name: file.name,
                            type: file.type,
                            size: file.size
                        });
                    }
                } else {
                    attachedFiles = attachedFiles.filter(af => af.id !== file.id);
                }
            });
        });
    }
    
    // Apply file selection
    function applyFileSelection() {
        updateAttachmentDisplay();
        document.querySelector('.fixed').remove();
        showToast(`${attachedFiles.length} files attached`, 'success');
    }
    

    
    // Update attachment display
    function updateAttachmentDisplay() {
        const attachmentArea = document.getElementById('fileAttachmentArea');
        const attachedFilesContainer = document.getElementById('attachedFiles');
        
        if (attachedFiles.length === 0) {
            attachmentArea.classList.add('hidden');
            return;
        }
        
        attachmentArea.classList.remove('hidden');
        
        attachedFilesContainer.innerHTML = '';
        attachedFiles.forEach(file => {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'inline-flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full border border-blue-200 hover:bg-blue-200 transition-colors';
            badgeDiv.innerHTML = `
                <i class="fas fa-file-${getFileIcon(file.type)} mr-2"></i>
                <span class="truncate max-w-32">${file.name}</span>
                <button onclick="removeAttachment('${file.id}')" class="ml-2 text-blue-600 hover:text-blue-800 focus:outline-none">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            attachedFilesContainer.appendChild(badgeDiv);
        });
    }
    
    // Remove attachment
    function removeAttachment(fileId) {
        attachedFiles = attachedFiles.filter(file => file.id !== fileId);
        updateAttachmentDisplay();
    }
    
    // Clear all attachments
    function clearAttachments() {
        attachedFiles = [];
        updateAttachmentDisplay();
    }
    

    
    // Upload file
    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        // No question field anymore, so just upload the file
        formData.append('question', '');
        
        try {
            showToast('Uploading file...', 'info');
            console.log('Uploading file:', file.name, 'Size:', file.size);
            
            const response = await fetch('/upload/', {
                method: 'POST',
                body: formData
            });
            
            console.log('Upload response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('Upload result:', result);
            
            if (result.success) {
                showToast(`File "${result.file_info.filename}" uploaded successfully!`, 'success');
                
                // Add file upload message to chat
                const messagesContainer = document.getElementById('chatMessages');
                const fileMessage = createMessageElement({
                    type: 'system',
                    message: `üìÅ File uploaded: ${result.file_info.filename} (${formatFileSize(result.file_info.file_size)})`,
                    timestamp: new Date().toISOString()
                });
                messagesContainer.appendChild(fileMessage);
                
                // Add AI analysis to chat
                const aiMessage = createMessageElement({
                    type: 'ai',
                    message: result.analysis,
                    timestamp: new Date().toISOString()
                });
                messagesContainer.appendChild(aiMessage);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Refresh uploaded files list
                loadUploadedFiles();
            } else {
                showToast(`Upload failed: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error('Upload error:', error);
            showToast(`Upload failed: ${error.message}`, 'error');
        }
    }
    
    // Folder processing
    async function processFolder() {
        const folderPath = document.getElementById('folderPath').value.trim();
        if (!folderPath) {
            showToast('Please enter a folder path', 'error');
            return;
        }
        
        try {
            showToast('Processing folder...', 'info');
            
            const response = await fetch('/folder/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({folder_path: folderPath})
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Folder processed successfully!', 'success');
                
                // Add messages to chat
                const messagesContainer = document.getElementById('chatMessages');
                
                const folderMessage = createMessageElement({
                    type: 'system',
                    message: `Analyzed folder: ${folderPath} (${result.folder_info.total_files} files)`,
                    timestamp: new Date().toISOString()
                });
                messagesContainer.appendChild(folderMessage);
                
                const aiMessage = createMessageElement({
                    type: 'ai',
                    message: result.ai_response,
                    timestamp: new Date().toISOString()
                });
                messagesContainer.appendChild(aiMessage);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Clear input
                document.getElementById('folderPath').value = '';
            } else {
                showToast(`Folder processing failed: ${result.error}`, 'error');
            }
        } catch (error) {
            showToast('Folder processing error occurred', 'error');
            console.error('Folder processing error:', error);
        }
    }
    
    // Database connection
    function showDatabaseModal() {
        document.getElementById('dbModal').classList.remove('hidden');
    }
    
    function hideDatabaseModal() {
        document.getElementById('dbModal').classList.add('hidden');
    }
    
    async function connectToDatabase() {
        const connectionData = {
            type: document.getElementById('dbType').value,
            server: document.getElementById('dbServer').value,
            database: document.getElementById('dbDatabase').value,
            username: document.getElementById('dbUsername').value,
            password: document.getElementById('dbPassword').value,
            port: parseInt(document.getElementById('dbPort').value) || 1433
        };
        
        if (!connectionData.server || !connectionData.database || !connectionData.username || !connectionData.password) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            showToast('Connecting to database...', 'info');
            
            const response = await fetch('/database/connect/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(connectionData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Database connected successfully!', 'success');
                document.getElementById('dbStatus').textContent = `Connected to ${connectionData.server}/${connectionData.database}`;
                document.getElementById('dbStatus').className = 'text-xs text-green-600';
                
                // Add messages to chat
                const messagesContainer = document.getElementById('chatMessages');
                
                const dbMessage = createMessageElement({
                    type: 'system',
                    message: `Connected to database: ${connectionData.server}/${connectionData.database}`,
                    timestamp: new Date().toISOString()
                });
                messagesContainer.appendChild(dbMessage);
                
                const aiMessage = createMessageElement({
                    type: 'ai',
                    message: result.ai_response,
                    timestamp: new Date().toISOString()
                });
                messagesContainer.appendChild(aiMessage);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                hideDatabaseModal();
                
                // Clear form
                document.getElementById('dbServer').value = '';
                document.getElementById('dbDatabase').value = '';
                document.getElementById('dbUsername').value = '';
                document.getElementById('dbPassword').value = '';
                document.getElementById('dbPort').value = '';
            } else {
                showToast(`Database connection failed: ${result.error}`, 'error');
            }
        } catch (error) {
            showToast('Database connection error occurred', 'error');
            console.error('Database connection error:', error);
        }
    }
    
    // Load uploaded files
    async function loadUploadedFiles() {
        try {
            const response = await fetch('/files/');
            const result = await response.json();
            
            if (result.success) {
                uploadedFilesList = result.files;
                displayUploadedFiles(result.files);
            }
        } catch (error) {
            console.error('Error loading uploaded files:', error);
        }
    }
    
    // Display uploaded files
    function displayUploadedFiles(files) {
        const container = document.getElementById('uploadedFiles');
        const fileCount = document.getElementById('fileCount');
        
        if (files.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No files uploaded yet</p>';
            fileCount.textContent = '0';
            return;
        }
        
        fileCount.textContent = files.length;
        container.innerHTML = '';
        files.forEach(file => {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
            fileDiv.innerHTML = `
                <div class="flex items-center space-x-2 flex-1 min-w-0">
                    <div class="text-blue-500 flex-shrink-0">
                        <i class="fas fa-file-${getFileIcon(file.type)}"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <p class="font-medium text-gray-800 text-sm truncate">${file.name}</p>
                        <p class="text-xs text-gray-500">${file.type.toUpperCase()} ‚Ä¢ ${formatFileSize(file.size)}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-1 flex-shrink-0">
                    <span class="px-2 py-1 text-xs rounded-full ${file.processed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                        ${file.processed ? '‚úì' : '‚è≥'}
                    </span>
                    <button onclick="askAboutFile(${file.id}, '${file.name}')" class="text-blue-600 hover:text-blue-800 text-xs p-1 rounded hover:bg-blue-50">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <button onclick="deleteFile(${file.id}, '${file.name}')" class="text-red-600 hover:text-red-800 text-xs p-1 rounded hover:bg-red-50">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(fileDiv);
        });
    }
    
    // Get file icon based on type
    function getFileIcon(type) {
        const icons = {
            'csv': 'csv',
            'xlsx': 'excel',
            'xls': 'excel',
            'txt': 'alt',
            'json': 'code',
            'pdf': 'pdf'
        };
        return icons[type] || 'alt';
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Format date
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    }
    
    // Ask about a specific file
    function askAboutFile(fileId, fileName) {
        const question = prompt(`What would you like to know about "${fileName}"?`);
        if (question) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value = `Question about ${fileName}: ${question}`;
            messageInput.focus();
        }
    }
    
    // Delete a file
    async function deleteFile(fileId, fileName) {
        if (!confirm(`Are you sure you want to delete "${fileName}"? This action cannot be undone.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/files/${fileId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(`File "${fileName}" deleted successfully`, 'success');
                // Refresh the file list
                loadUploadedFiles();
            } else {
                showToast(`Failed to delete file: ${result.error}`, 'error');
            }
        } catch (error) {
            console.error('Error deleting file:', error);
            showToast('Error deleting file. Please try again.', 'error');
        }
    }
    
    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize WebSocket
        initWebSocket();
        
        // Setup sidebar and accordion
        setupSidebar();
        
        // Setup file upload
        setupFileUpload();
        
        // Setup file attachments
        setupFileAttachments();
        
        // Load uploaded files
        loadUploadedFiles();
        
        // Message input handling
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        sendBtn.addEventListener('click', sendMessage);
        
        // Folder processing
        document.getElementById('processFolderBtn').addEventListener('click', processFolder);
        
        // Database connection
        document.getElementById('dbConnectBtn').addEventListener('click', showDatabaseModal);
        document.getElementById('dbConnectConfirm').addEventListener('click', connectToDatabase);
        document.getElementById('dbConnectCancel').addEventListener('click', hideDatabaseModal);
        
        // Close modal on outside click
        document.getElementById('dbModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideDatabaseModal();
            }
        });
    });
    
    // Keep connection alive
    setInterval(() => {
        if (isConnected && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({type: 'ping'}));
        }
    }, 30000); // Ping every 30 seconds
</script>
{% endblock %}